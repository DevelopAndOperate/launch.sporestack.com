<html>
<head>
<title>SporeStack: Infrastructure made simple</title>
  <meta charset="UTF-8">
  <meta name="description" content="Disposable servers for Bitcoin">
  <meta name="keywords" content="Bitcoin, immutable, disposable, vps, vpn, infrastructure">
  <meta name="author" content="SporeStack">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<link rel="stylesheet" href="/static/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u">
<script src="/static/index.bundle.js"></script>
<script src="/static/markdown.js"></script>
<script src="/static/FileSaver.min.js"></script>
</head>
<body>

<a target="_blank" href="https://github.com/sporestack/launch.sporestack.com"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>

<div class="container">
<h1><img style="margin:auto;display:block;max-width:100%;height:auto" src="/static/sporestack.png" alt="SporeStack"/></h1>
<center><h2>SporeStack Web Launcher</h2></center>
<script>
/* Not mine */
function uuid4(a){return a?(a^Math.random()*16>>a/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,uuid4)}
var uuid = uuid4();
</script>

<script src="/static/qrcode.min.js"></script>


<h3>Launch profile</h3>
<p>
    <div id="profile_options">
    Updating...
    </div>
</p>

<script>
function get_profile() {
    clearbitcoin();
    var description_element = document.getElementById('description');
    var profile_element = document.getElementById('profile');
    var profile_name = profile_element.options[profile_element.selectedIndex].value;
    var profile_request = new XMLHttpRequest();
    profile_request.open("get", "https://sporestack.com/launch/" + profile_name + ".json", true);
    profile_request.responseType = "json";
    profile_request.onload = function() {
        profile = profile_request.response;
        window.location.hash = profile['name'];
        description_element.innerHTML = markdown.toHTML(profile['description']);
        pay();
    }
    description_element.innerHTML = 'Updating...';
    profile_request.send();
}

function launch_optionator() {
    var launch_request = new XMLHttpRequest();
    launch_request.open("get", "https://sporestack.com/launch/index.json", true);
    launch_request.responseType = "json";
    var desired_profile = null;
    if (window.location.hash) {
        /* Strip off # */
        desired_profile = window.location.hash.substring(1);
    }
    launch_request.onload = function() {
        var options = "<select id='profile' onchange='get_profile();'>";
        var selected = null;
        for (profile in launch_request.response) {
            if (launch_request.response[profile]['name'] === desired_profile) {
                selected = 'selected="selected"'
            }
            options += '<option value=' + launch_request.response[profile]['name'] + ' ' + selected + '>' + launch_request.response[profile]['human_name'] + '</option>';
            selected = null;
        }
        options += '</select>'
        var element = document.getElementById('profile_options');
        element.innerHTML = options;
        get_profile();
    };
    launch_request.send();
}
</script>

<h3>Datacenter</h3>
<p>
    <div id="dcid_options">
    Updating...
    </div>
</p>

<script>
    var request = new XMLHttpRequest();
    request.open("get", "https://sporestack.com/node/options", true);
    request.responseType = "json";
    request.onload = function() {
        var options = "<select id='dcid' onchange='clearbitcoin();'>";
        for (dcid in request.response.dcid) {
            options += '<option value=' + dcid + '>' + request.response.dcid[dcid]['name'] + '</option>'     };
        options += '</select>'
        var element = document.getElementById('dcid_options');
        element.innerHTML = options;
        launch_optionator();
    };
    request.send();
</script>

<p>
Days to live: <input id="days" type="number" value="1" min="1" max="28" onchange='clearbitcoin();'>
</p>

<h3>Launch profile description</h3>
<div id="description"></div>

<div id="bitcoin_uri"></div>

<div id="postlaunch" style="visibility:hidden">
<br/><br/>
<p>
<pre><tt><div id="stdout"></div></tt></pre>
</p>
<input id="stdout_button" type="button" value="Save as file" onclick="saveAs(file);">
</div>

<script>
old_satoshis = 0;
var mimetype;
var every_other = true;
var node = {};
var file;
ready = false;
paid = false;


/* Fixme */
element = document.getElementById('bitcoin_uri');

function clearbitcoin() {
    console.log('clearing');
    element.innerHTML = 'Updating...';
    /* Force a refresh. */
    old_satoshis = 0;
}

function pay() {
    var dcid_element = document.getElementById('dcid');
    var options = {};
    options['unique'] = uuid;
    options['dcid'] = parseInt(dcid_element.options[dcid_element.selectedIndex].value);
    options['days'] = parseInt(document.getElementById('days').value);
    options['osid'] = parseInt(profile['osid']);
    options['startupscript'] = profile['startupscript'];
    options['sshkey'] = 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSs1NOWo6fOXko5I6tgrZEktNuZcFYNSGIpp1MPEyPgTgDSI8JQQ/bm76DIs6DUCrhqcKjAn28koN5Uyj9Pb0OrUwNDjOUhQ//6r/5F/pAKUcQ/3uk7XxAPOx+fVCYR9zwuNNGysExMUyUSGTYhZ2cfE+65eaC3Esbne5M6J7Ul7HP8CCBfeICqVvrIJcopgacD069sxtIdxWOyN56N2FktlV4C2YlQsxf1SJvqo193zlk2yagdUHleSkmP/IqW8yMNdltOAelYNd9VCfW8ROSA0yIj/zm5NZ7JdMoBa6In+gNUkNf4R7GHqHuEcCRELvV4ePlWEY6Oc+6b7aLN4Yj';
    var request = new XMLHttpRequest();
    request.open("post", "https://sporestack.com/node", true);
    request.setRequestHeader("Content-type", "application/json");
    request.responseType = "json";
    request.onload = function() {
        console.log('pay onload');
        if (request.status != 200) {
            element.innerHTML = request.statusText;
            setTimeout(function() { pay(); }, 5000);
            return;
        }
        if (request.response.hostname === null) {
            if (request.response.payment_status === false) {
                console.log('not yet paid');
                var bitcoin_uri = ('bitcoin:' + request.response.address + '?amount=' + sb.toBitcoin(request.response.satoshis));
                if (old_satoshis != request.response.satoshis) {
                    console.log('satoshis changed.');
                    element.innerHTML = ('<h3>Pay with Bitcoin</h3><a href="' + bitcoin_uri + '"><div id="qr"></div></a>');
                    new QRCode(document.getElementById("qr"), bitcoin_uri);
                    old_satoshis = request.response.satoshis;
                }
            } else {
                element.innerHTML = 'Payment received. Processing...';
            }
            /* Try again in 5 seconds. */
            setTimeout(function() { pay(); }, 5000);
        } else {
            if (profile['postlaunch'] === null) {
                console.log('no postlaunch');
                element.innerHTML = 'Server launched and will be online shortly: ' + request.response.hostname;
            } else {
                console.log('has postlaunch');
                element.innerHTML = 'Server created. (Will take about two minutes. Don\'t refresh or leave this page!) Booting.';
                setTimeout(function() { launch(uuid, profile['name']); }, 30000);
            }
        }
    }
    request.send(JSON.stringify(options));
}

function launch(uuid, profile) {
    console.log('in launch');
    var options = {};
    options['uuid'] = uuid;
    options['profile'] = profile;
    var request = new XMLHttpRequest();
    request.open("post", "/launch", true);
    request.setRequestHeader("Content-type", "application/json");
    request.responseType = "json";
    request.onload = function() {
        if (request.response.ready === true) {
            file = new File ([request.response.stdout], "openvpn.ovpn", {type: profile['mimetype']});
            element.innerHTML = '';
            var stdout_element = document.getElementById('stdout');
            stdout_element.innerHTML = request.response.stdout;
            document.getElementById('postlaunch').style.visibility = "visible";
        } else {
            element.innerHTML += '.';
            setTimeout(function() { launch(uuid, profile); }, 5000);
        }
    }
    request.send(JSON.stringify(options));
}
</script>

</div>
</body>
</html>
